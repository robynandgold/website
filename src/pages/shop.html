<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Shop — Robyn &amp; Gold</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta
    name="description"
    content="Browse the curated collection of antique and vintage rings from Robyn &amp; Gold."
  />

  <!-- Fonts (same as index) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600&family=Inter:wght@300;400;500;600&display=swap"
    rel="stylesheet"
  />

  <link rel="stylesheet" href="../css/styles.css" />
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png" />
  <link rel="manifest" href="/images/site.webmanifest" />
</head>
<body class="page">
  <header class="site-header">
    <div class="container header-inner">
      <nav class="nav nav-left" aria-label="Primary">
        <a href="shop.html" class="nav-link">Shop</a>
        <a href="../index.html#about" class="nav-link">Our story</a>
        <a href="../index.html#ethos" class="nav-link">Ethos</a>
      </nav>
      <div class="brand-banner">
        <div class="brand-center">
          <a href="../index.html">
            <img src="../images/logo.png" alt="Robyn & Gold" />
          </a>
          <a href="../index.html" class="brand-main">Robyn &amp; Gold</a>
          <span class="brand-tagline">Antique Jewellery</span>
        </div>
      </div>

      <nav class="nav nav-right" aria-label="Utilities">
        <a href="cart.html" class="nav-link nav-link--cart" aria-label="Cart">
          <svg viewBox="0 0 24 24" aria-hidden="true" class="icon-cart"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 001.98 1.61h9.72a2 2 0 001.98-1.61L23 6H6"/></svg>
          <span id="cart-count" class="cart-count">0</span>
        </a>
      </nav>
    </div>
  </header>

  <main>
    <!-- Filters + product grid -->
    <section class="section section--compact">
      <div class="container shop-layout">
        <aside class="shop-filters" aria-label="Filters">
          <h2 class="filters-title">Refine</h2>

          <label class="filter-group">
            <span class="filter-label">Era</span>
            <select id="filter-era" class="filter-select">
              <option value="">All eras</option>
              <option value="Victorian">Victorian</option>
              <option value="Edwardian">Edwardian</option>
              <option value="Art Deco">Art Deco</option>
              <option value="Georgian">Georgian</option>
              <option value="Retro">Mid-century / Retro</option>
            </select>
          </label>

          <label class="filter-group">
            <span class="filter-label">Category</span>
            <select id="filter-category" class="filter-select">
              <option value="">All categories</option>
              <option value="rings">Rings</option>
              <option value="necklaces">Necklaces</option>
              <option value="bracelets">Bracelets</option>
              <option value="earrings">Earrings</option>
              <option value="brooches">Brooches</option>
            </select>
          </label>

          <label class="filter-group">
            <span class="filter-label">Sort</span>
            <select id="filter-sort" class="filter-select">
              <option value="newest">Newest first</option>
              <option value="price-asc">Price · Low to high</option>
              <option value="price-desc">Price · High to low</option>
            </select>
          </label>

          <button id="clear-filters" class="btn btn-ghost btn-full">
            Clear filters
          </button>
        </aside>

        <div class="shop-results">
          <div class="shop-results-header">
            <p class="shop-count" id="product-count">Showing all pieces</p>
          </div>

          <!-- JS will render products here -->
          <div id="product-list" class="product-grid"></div>
        </div>
      </div>
    </section>
  </main>

  <script src="../js/products.js"></script>
  <script src="../js/cart.js"></script>
  <script>
    let allProducts = [];
    
    // Load and render products
    async function loadShopProducts() {
      console.log('=== SHOP PAGE: Starting to load products ===');
      
      // First try to load products directly without waiting for ProductsAPI
      try {
        console.log('Trying direct fetch of products...');
        const response = await fetch('../data/products.json');
        console.log('Direct fetch response:', response.status, response.ok);
        
        if (response.ok) {
          const products = await response.json();
          console.log('Direct fetch successful, got', products.length, 'products');
          // Filter for available products
          allProducts = products.filter(product => product.available !== false);
          console.log('Available products:', allProducts.length);
          renderProducts(allProducts);
          return; // Success, exit here
        }
      } catch (error) {
        console.log('Direct fetch failed:', error);
      }
      
      // Fallback to ProductsAPI method
      console.log('Falling back to ProductsAPI method...');
      
      // Wait for ProductsAPI to be available
      let attempts = 0;
      while (!window.ProductsAPI && attempts < 50) {
        console.log('Waiting for ProductsAPI, attempt:', attempts + 1);
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
      }
      
      if (!window.ProductsAPI) {
        console.error('ProductsAPI not available after waiting');
        const grid = document.getElementById('product-list');
        grid.innerHTML = '<p class="cart-empty-message">Failed to load ProductsAPI. Please refresh the page.</p>';
        return;
      }
      
      console.log('ProductsAPI is available, calling getAllProducts()');
      
      try {
        allProducts = await window.ProductsAPI.getAllProducts();
        console.log('Products loaded successfully:', allProducts.length, allProducts);
        
        if (!allProducts || allProducts.length === 0) {
          console.log('No products returned from getAllProducts()');
          const grid = document.getElementById('product-list');
          grid.innerHTML = '<p class="cart-empty-message">No products available.</p>';
          return;
        }
        
        renderProducts(allProducts);
      } catch (error) {
        console.error('Error calling getAllProducts():', error);
        const grid = document.getElementById('product-list');
        grid.innerHTML = '<p class="cart-empty-message">Failed to load products. Error: ' + error.message + '</p>';
      }
    }
    
    // Render products to grid
    function renderProducts(products) {
      const grid = document.getElementById('product-list');
      const countEl = document.getElementById('product-count');
      
      if (!products || products.length === 0) {
        grid.innerHTML = '<p class="cart-empty-message">No products found matching your filters.</p>';
        countEl.textContent = 'No pieces found';
        return;
      }
      
      countEl.textContent = `Showing ${products.length} ${products.length === 1 ? 'piece' : 'pieces'}`;
      
      grid.innerHTML = products.map(product => {
        // Safe price formatting
        const price = window.ProductsAPI?.formatPrice 
          ? window.ProductsAPI.formatPrice(product.price, product.currency)
          : `€${product.price}`;
        
        const productLink = `product-detail.html?slug=${product.slug}`;
          
        return `
        <article class="product-card">
          <a href="${productLink}">
            <img
              src="${product.images[0]}"
              alt="${product.name}"
              class="product-card-image"
              onerror="this.src='../images/homepage.png'"
            />
          </a>
          <div class="product-card-body">
            <h3 class="product-card-title">${product.name}</h3>
            <p class="product-card-meta">${product.era} · ${product.metal}</p>
            <p class="product-card-price">${price}</p>
            <a href="${productLink}" class="product-card-link">View details</a>
          </div>
        </article>
      `;}).join('');
    }
    
    // Filter and sort products
    function filterProducts() {
      const era = document.getElementById('filter-era').value;
      const category = document.getElementById('filter-category').value;
      const sort = document.getElementById('filter-sort').value;
      
      let filtered = [...allProducts];
      
      // Filter by era/period
      if (era) {
        filtered = filtered.filter(p => p.period === era);
      }
      
      // Filter by category
      if (category) {
        filtered = filtered.filter(p => (p.category || '').toLowerCase() === category.toLowerCase());
      }
      
      // Sort
      if (sort === 'price-asc') {
        filtered.sort((a, b) => a.price - b.price);
      } else if (sort === 'price-desc') {
        filtered.sort((a, b) => b.price - a.price);
      }
      
      renderProducts(filtered);
    }
    
    // Clear filters
    function clearFilters() {
      document.getElementById('filter-era').value = '';
      document.getElementById('filter-category').value = '';
      document.getElementById('filter-sort').value = 'newest';
      renderProducts(allProducts);
    }
    
    // Event listeners
    document.getElementById('filter-era').addEventListener('change', filterProducts);
    document.getElementById('filter-category').addEventListener('change', filterProducts);
    document.getElementById('filter-sort').addEventListener('change', filterProducts);
    document.getElementById('clear-filters').addEventListener('click', clearFilters);
    
    // Load products on page load
    document.addEventListener('DOMContentLoaded', loadShopProducts);
  </script>

  <footer class="site-footer">
    <div class="container footer-inner">
      <div class="footer-brand">
        <span class="brand-main">Robyn &amp; Gold</span>
        <span class="brand-tagline">Antique Jewellery</span>
      </div>
      <div class="footer-links">
        <a href="shop.html" class="footer-link">Shop</a>
        <a href="../index.html#about" class="footer-link">Our story</a>
        <a href="../index.html#ethos" class="footer-link">Ethos</a>
        <a href="contact.html" class="footer-link">Contact</a>
      </div>
      <p class="footer-meta">© <span id="year"></span> Robyn &amp; Gold. All rights reserved.</p>
    </div>
  </footer>

  <script>document.getElementById('year').textContent = new Date().getFullYear();</script>
</body>
</html>
